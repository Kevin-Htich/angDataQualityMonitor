<app-page-header
  [title]="feed?.name || 'Feed details'"
  [subtitle]="feed ? 'Service level targets and recent anomalies' : ''"
>
  <div actions *ngIf="feed">
    <app-status-chip [status]="feed.status"></app-status-chip>
    <mat-chip>Latency SLO {{ feed.slo.latencyMs }} ms</mat-chip>
    <mat-chip>Error SLO {{ feed.slo.errorRate }}%</mat-chip>
  </div>
</app-page-header>

<mat-progress-bar *ngIf="loading" mode="indeterminate"></mat-progress-bar>

<mat-tab-group *ngIf="!loading">
  <mat-tab label="Metrics">
    <div class="tab-content">
      <mat-card>
        <mat-card-title>Latency & Error Rate (24h)</mat-card-title>
        <div class="chart-wrapper">
          <canvas
            baseChart
            [data]="lineChartData"
            [labels]="lineChartLabels"
            [options]="lineChartOptions"
            [type]="'line'"
          ></canvas>
        </div>
      </mat-card>
    </div>
  </mat-tab>

  <mat-tab label="Anomalies">
    <div class="tab-content">
      <mat-card>
        <mat-card-title>Recent Anomalies</mat-card-title>
        <div class="table-wrapper">
          <table mat-table [dataSource]="anomalies" [trackBy]="trackById">
            <ng-container matColumnDef="type">
              <th mat-header-cell *matHeaderCellDef>Type</th>
              <td mat-cell *matCellDef="let anomaly">{{ anomaly.type }}</td>
            </ng-container>

            <ng-container matColumnDef="severity">
              <th mat-header-cell *matHeaderCellDef>Severity</th>
              <td mat-cell *matCellDef="let anomaly">
                <app-severity-chip [severity]="anomaly.severity"></app-severity-chip>
              </td>
            </ng-container>

            <ng-container matColumnDef="detectedAt">
              <th mat-header-cell *matHeaderCellDef>Detected</th>
              <td mat-cell *matCellDef="let anomaly">
                {{ anomaly.detectedAt | relativeTime : (now$ | async) }}
              </td>
            </ng-container>

            <ng-container matColumnDef="description">
              <th mat-header-cell *matHeaderCellDef>Description</th>
              <td mat-cell *matCellDef="let anomaly">{{ anomaly.description }}</td>
            </ng-container>

            <ng-container matColumnDef="actions">
              <th mat-header-cell *matHeaderCellDef></th>
              <td mat-cell *matCellDef="let anomaly">
                <button
                  mat-stroked-button
                  color="primary"
                  (click)="acknowledge(anomaly)"
                  [disabled]="anomaly.acknowledged"
                >
                  {{ anomaly.acknowledged ? 'Acknowledged' : 'Acknowledge' }}
                </button>
              </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="displayedAnomalyColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedAnomalyColumns"></tr>
          </table>
        </div>
      </mat-card>
    </div>
  </mat-tab>

  <mat-tab label="Incidents">
    <div class="tab-content">
      <mat-card>
        <mat-card-title>Incidents</mat-card-title>
        <div class="table-wrapper">
          <table mat-table [dataSource]="incidents" [trackBy]="trackById">
            <ng-container matColumnDef="id">
              <th mat-header-cell *matHeaderCellDef>Incident ID</th>
              <td mat-cell *matCellDef="let incident">{{ incident.id }}</td>
            </ng-container>

            <ng-container matColumnDef="title">
              <th mat-header-cell *matHeaderCellDef>Title</th>
              <td mat-cell *matCellDef="let incident">{{ incident.title }}</td>
            </ng-container>

            <ng-container matColumnDef="status">
              <th mat-header-cell *matHeaderCellDef>Status</th>
              <td mat-cell *matCellDef="let incident">{{ incident.status }}</td>
            </ng-container>

            <ng-container matColumnDef="severity">
              <th mat-header-cell *matHeaderCellDef>Severity</th>
              <td mat-cell *matCellDef="let incident">
                <app-severity-chip [severity]="incident.severity"></app-severity-chip>
              </td>
            </ng-container>

            <ng-container matColumnDef="owner">
              <th mat-header-cell *matHeaderCellDef>Owner</th>
              <td mat-cell *matCellDef="let incident">{{ incident.owner }}</td>
            </ng-container>

            <ng-container matColumnDef="updatedAt">
              <th mat-header-cell *matHeaderCellDef>Updated</th>
              <td mat-cell *matCellDef="let incident">
                {{ incident.updatedAt | relativeTime : (now$ | async) }}
              </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="displayedIncidentColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedIncidentColumns"></tr>
          </table>
        </div>
      </mat-card>
    </div>
  </mat-tab>
</mat-tab-group>
